# Supabase Storage Setup Guide

## Overview

This guide covers setting up Supabase Storage for video files in the Mimio app.

## Setup Steps

### 1. Run the Storage Migration

In your Supabase SQL Editor, run the migration file:

```sql
-- Copy and paste the contents of:
supabase/migrations/002_storage_setup.sql
```

This will:

- Create a `videos` storage bucket
- Set up Row Level Security (RLS) policies
- Configure user permissions for upload/download/delete

### 2. Verify Storage Bucket

1. Go to your Supabase dashboard
2. Navigate to **Storage** in the left sidebar
3. You should see a bucket named **videos**
4. The bucket should be marked as **Public**

### 3. Storage Structure

Videos are organized by user ID:

```
videos/
  ├── {user_id_1}/
  │   ├── video_abc123_1696234567890.mp4
  │   └── video_def456_1696234567891.mp4
  ├── {user_id_2}/
  │   └── video_ghi789_1696234567892.mp4
```

## Security Policies

The following RLS policies are in place:

- **Upload**: Users can only upload videos to their own folder (`{user_id}/`)
- **Read Own**: Users can read their own videos
- **Read Public**: Anyone can read public videos (for sharing)
- **Update**: Users can only update their own videos
- **Delete**: Users can only delete their own videos

## How It Works

### Video Creation Flow

1. User creates a video through the create-video page
2. Video is generated by the Sora API
3. Once complete, the video is:
   - Downloaded from the API as a blob
   - Uploaded to Supabase Storage (`videos/{user_id}/video_{id}_{timestamp}.mp4`)
   - Metadata saved to the `videos` database table
4. User can still download the video instantly
5. Video appears in the user's "My Videos" page

### Video Storage

- **Bucket**: `videos` (public bucket)
- **Path Format**: `{user_id}/video_{video_id}_{timestamp}.mp4`
- **Content Type**: `video/mp4`
- **Access**: Public URLs for easy sharing

## API Usage

### Upload Video

```typescript
import { storageApi } from "@/lib/supabase";

const { data, error } = await storageApi.uploadVideo(
  userId,
  videoBlob,
  "video_123_1696234567890.mp4"
);

if (data) {
  console.log("Public URL:", data.publicUrl);
  console.log("Storage Path:", data.path);
}
```

### Get Video URL

```typescript
const publicUrl = storageApi.getVideoUrl("user_id/video_123.mp4");
```

### Delete Video

```typescript
await storageApi.deleteVideo("user_id/video_123.mp4");
```

## Testing

1. Create a video through the app (logged in)
2. Wait for generation to complete
3. Check your Supabase Storage dashboard
4. You should see the video in `videos/{your_user_id}/`
5. Go to "My Videos" page - video should appear there
6. The download button should still work instantly

## Troubleshooting

### Videos not saving

- Check browser console for errors
- Verify user is logged in
- Check Supabase Storage permissions
- Verify the storage bucket exists

### Permission denied

- Check RLS policies in Supabase
- Ensure user is authenticated
- Verify user ID matches folder path

### Large files timing out

- Videos are saved asynchronously in the background
- Download still works even if save fails
- Check network tab for upload progress

## Future Enhancements

- [ ] Generate video thumbnails
- [ ] Add project selection when creating videos
- [ ] Track template ID for template-based videos
- [ ] Implement video compression for storage
- [ ] Add batch upload/download capabilities
